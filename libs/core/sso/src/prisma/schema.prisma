generator client {
  provider      = "prisma-client-js"
  output        = "../../../../../node_modules/@prisma/sso-client"
  binaryTargets = ["native", "rhel-openssl-3.0.x", "linux-musl-openssl-3.0.x"]
}

generator prismaClassGenerator {
  provider                        = "prisma-generator-nestjs-dto"
  output                          = "../lib/generated/rest/dto"
  createDtoPrefix                 = "Create"
  entitySuffix                    = ""
  fileNamingStyle                 = "kebab"
  dtoSuffix                       = "Dto"
  flatResourceStructure           = "false"
  exportRelationModifierClasses   = "true"
  reExport                        = "false"
  outputToNestJsResourceStructure = "false"
  entityPrefix                    = ""
  noDependencies                  = "false"
  classValidation                 = "true"
  prettier                        = "true"
  updateDtoPrefix                 = "Update"
  definiteAssignmentAssertion     = "true"
  annotateAllDtoProperties        = "true"
}

datasource db {
  provider = "postgres"
  url      = env("SERVER_SSO_DATABASE_URL")
}

model SsoProject {
  id                String              @id(map: "PK_SSO_PROJECTS") @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  clientId          String              @unique(map: "UQ_SSO_PROJECTS__CLIENT_ID")
  clientSecret      String
  createdAt         DateTime            @default(now()) @db.Timestamp(6)
  updatedAt         DateTime            @default(now()) @db.Timestamp(6)
  SsoRefreshSession SsoRefreshSession[]
  SsoTwoFactorCode  SsoTwoFactorCode?
  SsoUser           SsoUser[]
}

model SsoUser {
  id                String              @id(map: "PK_SSO_USERS") @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  email             String              @db.VarChar(254)
  phone             String?             @db.VarChar(254)
  username          String?             @db.VarChar(254)
  /// @DtoEntityHidden
  password          String              @db.VarChar(254)
  roles             String?             @db.VarChar(254)
  firstname         String?             @db.VarChar(254)
  lastname          String?             @db.VarChar(254)
  gender            String?             @db.VarChar(1)
  birthdate         DateTime?           @db.Timestamp(6)
  picture           String?
  appData           Json?
  revokedAt         DateTime?           @db.Timestamp(6)
  emailVerifiedAt   DateTime?           @db.Timestamp(6)
  phoneVerifiedAt   DateTime?           @db.Timestamp(6)
  projectId         String              @db.Uuid
  createdAt         DateTime            @default(now()) @db.Timestamp(6)
  updatedAt         DateTime            @default(now()) @db.Timestamp(6)
  SsoRefreshSession SsoRefreshSession[]
  SsoTwoFactorCode  SsoTwoFactorCode[]
  SsoProject        SsoProject          @relation(fields: [projectId], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "FK_SSO_USERS__PROJECT_ID")

  @@unique([email, projectId], map: "UQ_SSO_USERS__EMAIL")
  @@unique([username, projectId], map: "UQ_SSO_USERS__USERNAME")
  @@index([projectId], map: "IDX_SSO_USERS__PROJECT_ID")
}

model migrations_sso {
  installed_rank Int      @id(map: "__migrations_sso_pk")
  version        String?  @db.VarChar(50)
  description    String   @db.VarChar(200)
  type           String   @db.VarChar(20)
  script         String   @db.VarChar(1000)
  checksum       Int?
  installed_by   String   @db.VarChar(100)
  installed_on   DateTime @default(now()) @db.Timestamp(6)
  execution_time Int
  success        Boolean

  @@index([success], map: "__migrations_sso_s_idx")
  @@map("__migrations_sso")
}

model SsoRefreshSession {
  id           String     @id(map: "PK_SSO_REFRESH_SESSIONS") @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  /// @DtoEntityHidden
  refreshToken String     @db.Uuid
  userAgent    String?    @db.VarChar(254)
  /// @DtoEntityHidden
  fingerprint  String?    @db.VarChar(254)
  userIp       String?    @db.VarChar(128)
  expiresIn    BigInt?
  userId       String     @db.Uuid
  projectId    String     @db.Uuid
  createdAt    DateTime   @default(now()) @db.Timestamp(6)
  updatedAt    DateTime   @default(now()) @db.Timestamp(6)
  SsoProject   SsoProject @relation(fields: [projectId], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "FK_SSO_REFRESH_SESSIONS__PROJECT_ID")
  SsoUser      SsoUser    @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "FK_SSO_REFRESH_SESSIONS__USER_ID")

  @@unique([userId, fingerprint, projectId], map: "UQ_SSO_REFRESH_SESSIONS")
  @@index([userId, projectId], map: "IDX_SSO_REFRESH_SESSIONS_USER_ID")
  @@index([projectId], map: "IDX_SSO_REFRESH_SESSIONS__PROJECT_ID")
}

model SsoTwoFactorCode {
  id            String     @id(map: "PK_SSO_TWO_FACTOR_CODES") @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  operationName String     @db.VarChar(512)
  /// @DtoEntityHidden
  code          String     @db.VarChar(100)
  type          String     @db.VarChar(100)
  maxAttempt    Int
  attempt       Int
  timeout       Int
  used          Boolean
  userId        String     @db.Uuid
  projectId     String     @unique(map: "IDX_SSO_TWO_FACTOR_CODES__PROJECT_ID") @db.Uuid
  createdAt     DateTime   @default(now()) @db.Timestamp(6)
  updatedAt     DateTime   @default(now()) @db.Timestamp(6)
  SsoProject    SsoProject @relation(fields: [projectId], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "FK_SSO_TWO_FACTOR_CODES__PROJECT_ID")
  SsoUser       SsoUser    @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "FK_SSO_TWO_FACTOR_CODES__USER_ID")

  @@unique([userId, operationName, code, projectId], map: "UQ_SSO_TWO_FACTOR_CODES")
  @@unique([userId, projectId], map: "IDX_SSO_TWO_FACTOR_CODES__USER_ID")
}
